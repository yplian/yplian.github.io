{"title":"vue数据双向绑定","slug":"vue数据双向绑定","date":"2018-08-06T16:00:00.000Z","updated":"2018-08-06T16:00:00.000Z","comments":true,"path":"api/articles/vue数据双向绑定.json","excerpt":"前段时间的react项目，通过最近的闲暇时间，重构了一版vue的PC版本，备用链接,对于vue的数据双向绑定产生，探讨一下。","covers":["../images/vue_data.png"],"content":"<p>前段时间的react项目，通过最近的闲暇时间，重构了一版<a href=\"http://luckyp.top/vue-cnode/\">vue的PC版本</a>，<a href=\"https://vcnode.luckyp.top/\" target=\"_blank\" rel=\"noopener\">备用链接</a>,对于vue的数据双向绑定产生，探讨一下。</p>\n<a id=\"more\"></a>\n<h2 id=\"几种绑定方式\"><a href=\"#几种绑定方式\" class=\"headerlink\" title=\"几种绑定方式\"></a>几种绑定方式</h2><h3 id=\"发布者-订阅者模式（backbone-js）\"><a href=\"#发布者-订阅者模式（backbone-js）\" class=\"headerlink\" title=\"发布者-订阅者模式（backbone.js）\"></a>发布者-订阅者模式（backbone.js）</h3><p>通过自定义的data属性在HTML代码中指明绑定。所有绑定起来的JavaScript对象以及DOM元素都将“订阅”一个发布者对象。任何时候如果JavaScript对象或者一个HTML输入字段被侦测到发生了变化，我们将代理事件到发布者-订阅者模式，这会反过来将变化广播并传播到所有绑定的对象和元素。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">data-bind-123</span>=<span class=\"string\">\"name\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>  <span class=\"attr\">data-bind-123</span>=<span class=\"string\">\"name\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">DataBinder</span>(<span class=\"params\">object_id</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">//创建一个简单地PubSub对象</span></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> pubSub = &#123;</span></span><br><span class=\"line\">        callbacks: &#123;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">// 订阅事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">        on:<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">msg, callback</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">this</span>.callbacks[msg] = <span class=\"keyword\">this</span>.callbacks[msg] || [];</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">this</span>.callbacks[msg].push(callback);</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">// 发布事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">        publish: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">msg</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">this</span>.callbacks[msg] = <span class=\"keyword\">this</span>.callbacks[msg] || [];</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>, len=<span class=\"keyword\">this</span>.callbacks[msg].length; i&lt;len; i++)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">this</span>.callbacks[msg][i].apply(<span class=\"keyword\">this</span>,<span class=\"built_in\">arguments</span>);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">    data_attr = <span class=\"string\">\"data-bind-\"</span> + object_id,</span></span><br><span class=\"line\"><span class=\"javascript\">    message = object_id + <span class=\"string\">\":input\"</span>,</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  changeHandler = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">evt</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> target = evt.target || evt.srcElemnt, <span class=\"comment\">//IE8兼容</span></span></span><br><span class=\"line\">    prop_name = target.getAttribute(data_attr);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span>(prop_name &amp;&amp; prop_name !== <span class=\"string\">\"\"</span>)&#123;</span></span><br><span class=\"line\">      pubSub.publish(message, prop_name, target.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"comment\">//监听变化事件并代理到PubSub</span></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">if</span>(<span class=\"built_in\">document</span>.addEventListener)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">\"input\"</span>,changeHandler,<span class=\"literal\">false</span>);</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"comment\">//PubSub将变化传播到所有绑定元素</span></span></span><br><span class=\"line\"><span class=\"javascript\">  pubSub.on(message,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">vet,prop_name,new_val</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> elements = <span class=\"built_in\">document</span>.querySelectorAll(<span class=\"string\">\"[\"</span> + data_attr + <span class=\"string\">\"=\"</span> + prop_name + <span class=\"string\">\"]\"</span>),</span></span><br><span class=\"line\">    tah_name;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>,len =elements.length; i &lt; len; i++)&#123;</span></span><br><span class=\"line\">      tag_name = elements[i].tagName.toLowerCase();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">if</span>(tag_name === <span class=\"string\">\"input\"</span> || tag_name === <span class=\"string\">\"textarea\"</span> || tag_name === <span class=\"string\">\"select\"</span>)&#123;</span></span><br><span class=\"line\">        elements[i].value = new_val;</span><br><span class=\"line\"><span class=\"javascript\">      &#125;<span class=\"keyword\">else</span>&#123;</span></span><br><span class=\"line\">        elements[i].innerHTML = new_val;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> pubSub;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">User</span>(<span class=\"params\">uid</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\"> <span class=\"keyword\">var</span> binder = <span class=\"keyword\">new</span> DataBinder(uid),</span></span><br><span class=\"line\">  user = &#123;</span><br><span class=\"line\">   atttibutes: &#123;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">   <span class=\"comment\">//属性设置器使用数据绑定器PubSub来发布变化</span></span></span><br><span class=\"line\"><span class=\"javascript\">   <span class=\"keyword\">set</span>: function(attr_name,val)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.atttibutes[attr_name] = val;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">//使用“publish”方法</span></span></span><br><span class=\"line\"><span class=\"javascript\">    binder.publish(uid+ <span class=\"string\">\":input\"</span>, attr_name, val,<span class=\"keyword\">this</span>);</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">   <span class=\"keyword\">get</span>: function(attr_name)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.atttibutes[attr_name];</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">   binder: binder</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"> binder.on(uid +<span class=\"string\">\":input\"</span>,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">vet,attr_name,new_val,initiator</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">if</span>(initiator !== user)&#123;</span></span><br><span class=\"line\">   user.set(attr_name,new_val);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"> <span class=\"keyword\">return</span> user;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">var</span> user = <span class=\"keyword\">new</span> User(<span class=\"number\">123</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">user.set(<span class=\"string\">\"name\"</span>,<span class=\"string\">\"Wolfgang\"</span>);</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"脏值检查（angular-js）\"><a href=\"#脏值检查（angular-js）\" class=\"headerlink\" title=\"脏值检查（angular.js）\"></a>脏值检查（angular.js）</h3><p>angular.js 是通过脏值检测的方式比对数据是否有变更，来决定是否更新视图，最简单的方式就是通过 setInterval() 定时轮询检测数据变动，angular只有在指定的事件触发时进入脏值检测，大致如下：</p>\n<ul>\n<li>DOM事件，譬如用户输入文本，点击按钮等。( ng-click )</li>\n<li>XHR响应事件 ( $http )</li>\n<li>浏览器Location变更事件 ( $location )</li>\n<li>Timer事件( $timeout , $interval )</li>\n<li>执行 $digest() 或 $apply()</li>\n</ul>\n<h3 id=\"数据劫持（Vue-js）\"><a href=\"#数据劫持（Vue-js）\" class=\"headerlink\" title=\"数据劫持（Vue.js）\"></a>数据劫持（Vue.js）</h3><p>vue.js 则是采用数据劫持结合发布者-订阅者模式的方式，通过Object.defineProperty()来劫持各个属性的setter，getter，在数据变动时发布消息给订阅者，触发相应的监听回调。</p>\n<h2 id=\"官方介绍\"><a href=\"#官方介绍\" class=\"headerlink\" title=\"官方介绍\"></a>官方介绍</h2><p>vue当前使用的版本为v2.5.2，<a href=\"https://cn.vuejs.org/v2/guide/reactivity.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>的相关内容是关于深入响应式原理。</p>\n<blockquote>\n<p>当你把一个普通的 JavaScript 对象传给 Vue 实例的 data 选项，Vue 将遍历此对象所有的属性，并使用 Object.defineProperty 把这些属性全部转为 getter/setter。Object.defineProperty 是 ES5 中一个无法 shim 的特性，这也就是为什么 Vue 不支持 IE8 以及更低版本浏览器。<br>这些 getter/setter 对用户来说是不可见的，但是在内部它们让 Vue 追踪依赖，在属性被访问和修改时通知变化。这里需要注意的问题是浏览器控制台在打印数据对象时 getter/setter 的格式化并不同，所以你可能需要安装 vue-devtools 来获取更加友好的检查接口。<br>每个组件实例都有相应的 watcher 实例对象，它会在组件渲染的过程中把属性记录为依赖，之后当依赖项的 setter 被调用时，会通知 watcher 重新计算，从而致使它关联的组件得以更新。</p>\n</blockquote>\n<p><img src=\"../images/vue_data.png\" alt=\"vue_data.png\"></p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><h3 id=\"原理实现\"><a href=\"#原理实现\" class=\"headerlink\" title=\"原理实现\"></a>原理实现</h3><p>当<code>EventListener</code>监听的事件触发，状态发生改变时，通过<code>Object.defineProperty</code>的<code>get/set</code>拦截事件，从而实现数据的双向绑定。</p>\n<p>关于<code>Object.defineProperty</code>可在<a href=\"http://luckyp.top/高程笔记-对象1\">高程笔记-对象1</a>有简单介绍，也可在<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty\" target=\"_blank\" rel=\"noopener\">MDN</a>查看。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"input\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"output\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"app.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* app.js */</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> obj = &#123;&#125;</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.defineProperty(obj, <span class=\"string\">\"data\"</span>, &#123;</span><br><span class=\"line\">    <span class=\"keyword\">get</span>: function () &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"get\"</span>)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"keyword\">set</span>: function (newValue) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"set:\"</span>+newValue)</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"input\"</span>).value = newValue</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"output\"</span>).innerText = newValue</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"input\"</span>).addEventListener(<span class=\"string\">'keyup'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">event</span>) </span>&#123;</span><br><span class=\"line\">    obj.data = event.target.value</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"简单实现\"><a href=\"#简单实现\" class=\"headerlink\" title=\"简单实现\"></a>简单实现</h3><p>实现双向绑定，需要实现</p>\n<ul>\n<li>数据监听器Observer，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者</li>\n<li>指令解析器Compile，对每个元素节点的指令进行扫描和解析，根据指令模板替换数据，以及绑定相应的更新函数</li>\n<li>Watcher，作为连接Observer和Compile的桥梁，能够订阅并收到每个属性变动的通知，执行指令绑定的相应回调函数，从而更新视图</li>\n<li>入口函数</li>\n</ul>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>  <span class=\"attr\">lang</span>=<span class=\"string\">\"en\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"UTF-8\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">\"viewport\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"width=device-width, initial-scale=1.0\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">\"X-UA-Compatible\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"ie=edge\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>simple vue<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"text\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123;text&#125;&#125;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">　　<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Compile</span>(<span class=\"params\">node, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">if</span>(node) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.$frag = <span class=\"keyword\">this</span>.nodeToFragment(node, vm);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.$frag;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Compile.prototype = &#123;</span><br><span class=\"line\"><span class=\"javascript\">      nodeToFragment: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">node, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> frag = <span class=\"built_in\">document</span>.createDocumentFragment();</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> child;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">while</span>(child = node.firstChild) &#123;</span></span><br><span class=\"line\">          self.compileElement(child, vm);</span><br><span class=\"line\"><span class=\"javascript\">          frag.append(child); <span class=\"comment\">// 将所有子节点添加到fragment中</span></span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span> frag;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\"><span class=\"javascript\">      compileElement: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">node, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> reg = <span class=\"regexp\">/\\&#123;\\&#123;(.*)\\&#125;\\&#125;/</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">//节点类型为元素</span></span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span>(node.nodeType === <span class=\"number\">1</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">var</span> attr = node.attributes;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"comment\">// 解析属性</span></span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; attr.length; i++ ) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">if</span>(attr[i].nodeName == <span class=\"string\">'v-model'</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">              <span class=\"keyword\">var</span> name = attr[i].nodeValue; <span class=\"comment\">// 获取v-model绑定的属性名</span></span></span><br><span class=\"line\"><span class=\"javascript\">              node.addEventListener(<span class=\"string\">'input'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"comment\">// 给相应的data属性赋值，进而触发该属性的set方法</span></span></span><br><span class=\"line\">                 vm[name]= e.target.value;</span><br><span class=\"line\">              &#125;);</span><br><span class=\"line\"><span class=\"javascript\">              <span class=\"comment\">// node.value = vm[name]; // 将data的值赋给该node</span></span></span><br><span class=\"line\"><span class=\"javascript\">              <span class=\"keyword\">new</span> Watcher(vm, node, name, <span class=\"string\">'value'</span>);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">//节点类型为text</span></span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span>(node.nodeType === <span class=\"number\">3</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">if</span>(reg.test(node.nodeValue)) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> name = <span class=\"built_in\">RegExp</span>.$<span class=\"number\">1</span>; <span class=\"comment\">// 获取匹配到的字符串</span></span></span><br><span class=\"line\">            name = name.trim();</span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"comment\">// node.nodeValue = vm[name]; // 将data的值赋给该node</span></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">new</span> Watcher(vm, node, name, <span class=\"string\">'nodeValue'</span>);</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dep</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.subs = [];</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Dep.prototype = &#123;</span><br><span class=\"line\"><span class=\"javascript\">      addSub: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">sub</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.subs.push(sub);</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\"><span class=\"javascript\">      notify: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.subs.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">sub</span>) </span>&#123;</span></span><br><span class=\"line\">          sub.update();</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Watcher</span>(<span class=\"params\">vm, node, name, type</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      Dep.target = <span class=\"keyword\">this</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.name = name;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.node = node;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.vm = vm;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.type = type;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.update();</span></span><br><span class=\"line\"><span class=\"javascript\">      Dep.target = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Watcher.prototype = &#123;</span><br><span class=\"line\"><span class=\"javascript\">      update: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.get();</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.node[<span class=\"keyword\">this</span>.type] = <span class=\"keyword\">this</span>.value; <span class=\"comment\">// 订阅者执行相应操作</span></span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// 获取data的属性值</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">get</span>: function() &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.value = <span class=\"keyword\">this</span>.vm[<span class=\"keyword\">this</span>.name]; <span class=\"comment\">//触发相应属性的get</span></span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">defineReactive</span> (<span class=\"params\">obj, key, val</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> dep = <span class=\"keyword\">new</span> Dep();</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">Object</span>.defineProperty(obj, key, &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">get</span>: function() &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">           <span class=\"comment\">//添加订阅者watcher到主题对象Dep</span></span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">if</span>(Dep.target) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"comment\">// JS的浏览器单线程特性，保证这个全局变量在同一时间内，只会有同一个监听器使用</span></span></span><br><span class=\"line\">            dep.addSub(Dep.target);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">return</span> val;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">set</span>: function (newVal) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">if</span>(newVal === val) <span class=\"keyword\">return</span>;</span></span><br><span class=\"line\">          val = newVal;</span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"built_in\">console</span>.log(val);</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"comment\">// 作为发布者发出通知</span></span></span><br><span class=\"line\">          dep.notify();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">observe</span>(<span class=\"params\">obj, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">Object</span>.keys(obj).forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span></span><br><span class=\"line\">        defineReactive(vm, key, obj[key]);</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"> 　 <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Vue</span>(<span class=\"params\">options</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.data = options.data;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> data = <span class=\"keyword\">this</span>.data;</span></span><br><span class=\"line\"><span class=\"javascript\">      observe(data, <span class=\"keyword\">this</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> id = options.el;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> dom =<span class=\"keyword\">new</span> Compile(<span class=\"built_in\">document</span>.getElementById(id),<span class=\"keyword\">this</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// 编译完成后，将dom返回到app中</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">document</span>.getElementById(id).appendChild(dom);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> vm = <span class=\"keyword\">new</span> Vue(&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      el: <span class=\"string\">'app'</span>,</span></span><br><span class=\"line\">      data: &#123;</span><br><span class=\"line\"><span class=\"javascript\">        text: <span class=\"string\">'hello world'</span></span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>参考链接<br><a href=\"http://www.html-js.com/article/Study-of-twoway-data-binding-JavaScript-talk-about-JavaScript-every-day\" target=\"_blank\" rel=\"noopener\">http://www.html-js.com/article/Study-of-twoway-data-binding-JavaScript-talk-about-JavaScript-every-day</a><br><a href=\"https://segmentfault.com/a/1190000006599500\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/a/1190000006599500</a></p>\n","more":"<h2 id=\"几种绑定方式\"><a href=\"#几种绑定方式\" class=\"headerlink\" title=\"几种绑定方式\"></a>几种绑定方式</h2><h3 id=\"发布者-订阅者模式（backbone-js）\"><a href=\"#发布者-订阅者模式（backbone-js）\" class=\"headerlink\" title=\"发布者-订阅者模式（backbone.js）\"></a>发布者-订阅者模式（backbone.js）</h3><p>通过自定义的data属性在HTML代码中指明绑定。所有绑定起来的JavaScript对象以及DOM元素都将“订阅”一个发布者对象。任何时候如果JavaScript对象或者一个HTML输入字段被侦测到发生了变化，我们将代理事件到发布者-订阅者模式，这会反过来将变化广播并传播到所有绑定的对象和元素。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">data-bind-123</span>=<span class=\"string\">\"name\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>  <span class=\"attr\">data-bind-123</span>=<span class=\"string\">\"name\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">DataBinder</span>(<span class=\"params\">object_id</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">//创建一个简单地PubSub对象</span></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> pubSub = &#123;</span></span><br><span class=\"line\">        callbacks: &#123;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">// 订阅事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">        on:<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">msg, callback</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">this</span>.callbacks[msg] = <span class=\"keyword\">this</span>.callbacks[msg] || [];</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">this</span>.callbacks[msg].push(callback);</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">// 发布事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">        publish: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">msg</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">this</span>.callbacks[msg] = <span class=\"keyword\">this</span>.callbacks[msg] || [];</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>, len=<span class=\"keyword\">this</span>.callbacks[msg].length; i&lt;len; i++)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">this</span>.callbacks[msg][i].apply(<span class=\"keyword\">this</span>,<span class=\"built_in\">arguments</span>);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">    data_attr = <span class=\"string\">\"data-bind-\"</span> + object_id,</span></span><br><span class=\"line\"><span class=\"javascript\">    message = object_id + <span class=\"string\">\":input\"</span>,</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  changeHandler = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">evt</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> target = evt.target || evt.srcElemnt, <span class=\"comment\">//IE8兼容</span></span></span><br><span class=\"line\">    prop_name = target.getAttribute(data_attr);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">if</span>(prop_name &amp;&amp; prop_name !== <span class=\"string\">\"\"</span>)&#123;</span></span><br><span class=\"line\">      pubSub.publish(message, prop_name, target.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"comment\">//监听变化事件并代理到PubSub</span></span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">if</span>(<span class=\"built_in\">document</span>.addEventListener)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">\"input\"</span>,changeHandler,<span class=\"literal\">false</span>);</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"comment\">//PubSub将变化传播到所有绑定元素</span></span></span><br><span class=\"line\"><span class=\"javascript\">  pubSub.on(message,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">vet,prop_name,new_val</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> elements = <span class=\"built_in\">document</span>.querySelectorAll(<span class=\"string\">\"[\"</span> + data_attr + <span class=\"string\">\"=\"</span> + prop_name + <span class=\"string\">\"]\"</span>),</span></span><br><span class=\"line\">    tah_name;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>,len =elements.length; i &lt; len; i++)&#123;</span></span><br><span class=\"line\">      tag_name = elements[i].tagName.toLowerCase();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">if</span>(tag_name === <span class=\"string\">\"input\"</span> || tag_name === <span class=\"string\">\"textarea\"</span> || tag_name === <span class=\"string\">\"select\"</span>)&#123;</span></span><br><span class=\"line\">        elements[i].value = new_val;</span><br><span class=\"line\"><span class=\"javascript\">      &#125;<span class=\"keyword\">else</span>&#123;</span></span><br><span class=\"line\">        elements[i].innerHTML = new_val;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">return</span> pubSub;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">User</span>(<span class=\"params\">uid</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\"> <span class=\"keyword\">var</span> binder = <span class=\"keyword\">new</span> DataBinder(uid),</span></span><br><span class=\"line\">  user = &#123;</span><br><span class=\"line\">   atttibutes: &#123;&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">   <span class=\"comment\">//属性设置器使用数据绑定器PubSub来发布变化</span></span></span><br><span class=\"line\"><span class=\"javascript\">   <span class=\"keyword\">set</span>: function(attr_name,val)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">this</span>.atttibutes[attr_name] = val;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"comment\">//使用“publish”方法</span></span></span><br><span class=\"line\"><span class=\"javascript\">    binder.publish(uid+ <span class=\"string\">\":input\"</span>, attr_name, val,<span class=\"keyword\">this</span>);</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">   <span class=\"keyword\">get</span>: function(attr_name)&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.atttibutes[attr_name];</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\"></span><br><span class=\"line\">   binder: binder</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"> binder.on(uid +<span class=\"string\">\":input\"</span>,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">vet,attr_name,new_val,initiator</span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">  <span class=\"keyword\">if</span>(initiator !== user)&#123;</span></span><br><span class=\"line\">   user.set(attr_name,new_val);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"> <span class=\"keyword\">return</span> user;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">var</span> user = <span class=\"keyword\">new</span> User(<span class=\"number\">123</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">user.set(<span class=\"string\">\"name\"</span>,<span class=\"string\">\"Wolfgang\"</span>);</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"脏值检查（angular-js）\"><a href=\"#脏值检查（angular-js）\" class=\"headerlink\" title=\"脏值检查（angular.js）\"></a>脏值检查（angular.js）</h3><p>angular.js 是通过脏值检测的方式比对数据是否有变更，来决定是否更新视图，最简单的方式就是通过 setInterval() 定时轮询检测数据变动，angular只有在指定的事件触发时进入脏值检测，大致如下：</p>\n<ul>\n<li>DOM事件，譬如用户输入文本，点击按钮等。( ng-click )</li>\n<li>XHR响应事件 ( $http )</li>\n<li>浏览器Location变更事件 ( $location )</li>\n<li>Timer事件( $timeout , $interval )</li>\n<li>执行 $digest() 或 $apply()</li>\n</ul>\n<h3 id=\"数据劫持（Vue-js）\"><a href=\"#数据劫持（Vue-js）\" class=\"headerlink\" title=\"数据劫持（Vue.js）\"></a>数据劫持（Vue.js）</h3><p>vue.js 则是采用数据劫持结合发布者-订阅者模式的方式，通过Object.defineProperty()来劫持各个属性的setter，getter，在数据变动时发布消息给订阅者，触发相应的监听回调。</p>\n<h2 id=\"官方介绍\"><a href=\"#官方介绍\" class=\"headerlink\" title=\"官方介绍\"></a>官方介绍</h2><p>vue当前使用的版本为v2.5.2，<a href=\"https://cn.vuejs.org/v2/guide/reactivity.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>的相关内容是关于深入响应式原理。</p>\n<blockquote>\n<p>当你把一个普通的 JavaScript 对象传给 Vue 实例的 data 选项，Vue 将遍历此对象所有的属性，并使用 Object.defineProperty 把这些属性全部转为 getter/setter。Object.defineProperty 是 ES5 中一个无法 shim 的特性，这也就是为什么 Vue 不支持 IE8 以及更低版本浏览器。<br>这些 getter/setter 对用户来说是不可见的，但是在内部它们让 Vue 追踪依赖，在属性被访问和修改时通知变化。这里需要注意的问题是浏览器控制台在打印数据对象时 getter/setter 的格式化并不同，所以你可能需要安装 vue-devtools 来获取更加友好的检查接口。<br>每个组件实例都有相应的 watcher 实例对象，它会在组件渲染的过程中把属性记录为依赖，之后当依赖项的 setter 被调用时，会通知 watcher 重新计算，从而致使它关联的组件得以更新。</p>\n</blockquote>\n<p><img src=\"../images/vue_data.png\" alt=\"vue_data.png\"></p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><h3 id=\"原理实现\"><a href=\"#原理实现\" class=\"headerlink\" title=\"原理实现\"></a>原理实现</h3><p>当<code>EventListener</code>监听的事件触发，状态发生改变时，通过<code>Object.defineProperty</code>的<code>get/set</code>拦截事件，从而实现数据的双向绑定。</p>\n<p>关于<code>Object.defineProperty</code>可在<a href=\"http://luckyp.top/高程笔记-对象1\">高程笔记-对象1</a>有简单介绍，也可在<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty\" target=\"_blank\" rel=\"noopener\">MDN</a>查看。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"input\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"output\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"app.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* app.js */</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> obj = &#123;&#125;</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.defineProperty(obj, <span class=\"string\">\"data\"</span>, &#123;</span><br><span class=\"line\">    <span class=\"keyword\">get</span>: function () &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"get\"</span>)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"keyword\">set</span>: function (newValue) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"set:\"</span>+newValue)</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"input\"</span>).value = newValue</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"output\"</span>).innerText = newValue</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"input\"</span>).addEventListener(<span class=\"string\">'keyup'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">event</span>) </span>&#123;</span><br><span class=\"line\">    obj.data = event.target.value</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"简单实现\"><a href=\"#简单实现\" class=\"headerlink\" title=\"简单实现\"></a>简单实现</h3><p>实现双向绑定，需要实现</p>\n<ul>\n<li>数据监听器Observer，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者</li>\n<li>指令解析器Compile，对每个元素节点的指令进行扫描和解析，根据指令模板替换数据，以及绑定相应的更新函数</li>\n<li>Watcher，作为连接Observer和Compile的桥梁，能够订阅并收到每个属性变动的通知，执行指令绑定的相应回调函数，从而更新视图</li>\n<li>入口函数</li>\n</ul>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>  <span class=\"attr\">lang</span>=<span class=\"string\">\"en\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"UTF-8\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">\"viewport\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"width=device-width, initial-scale=1.0\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">\"X-UA-Compatible\"</span> <span class=\"attr\">content</span>=<span class=\"string\">\"ie=edge\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>simple vue<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">v-model</span>=<span class=\"string\">\"text\"</span>&gt;</span></span><br><span class=\"line\">    &#123;&#123;text&#125;&#125;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\">　　<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Compile</span>(<span class=\"params\">node, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">if</span>(node) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.$frag = <span class=\"keyword\">this</span>.nodeToFragment(node, vm);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.$frag;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Compile.prototype = &#123;</span><br><span class=\"line\"><span class=\"javascript\">      nodeToFragment: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">node, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> frag = <span class=\"built_in\">document</span>.createDocumentFragment();</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> child;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">while</span>(child = node.firstChild) &#123;</span></span><br><span class=\"line\">          self.compileElement(child, vm);</span><br><span class=\"line\"><span class=\"javascript\">          frag.append(child); <span class=\"comment\">// 将所有子节点添加到fragment中</span></span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">return</span> frag;</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\"><span class=\"javascript\">      compileElement: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">node, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> reg = <span class=\"regexp\">/\\&#123;\\&#123;(.*)\\&#125;\\&#125;/</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">//节点类型为元素</span></span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span>(node.nodeType === <span class=\"number\">1</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">var</span> attr = node.attributes;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"comment\">// 解析属性</span></span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; attr.length; i++ ) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">if</span>(attr[i].nodeName == <span class=\"string\">'v-model'</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">              <span class=\"keyword\">var</span> name = attr[i].nodeValue; <span class=\"comment\">// 获取v-model绑定的属性名</span></span></span><br><span class=\"line\"><span class=\"javascript\">              node.addEventListener(<span class=\"string\">'input'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"comment\">// 给相应的data属性赋值，进而触发该属性的set方法</span></span></span><br><span class=\"line\">                 vm[name]= e.target.value;</span><br><span class=\"line\">              &#125;);</span><br><span class=\"line\"><span class=\"javascript\">              <span class=\"comment\">// node.value = vm[name]; // 将data的值赋给该node</span></span></span><br><span class=\"line\"><span class=\"javascript\">              <span class=\"keyword\">new</span> Watcher(vm, node, name, <span class=\"string\">'value'</span>);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"comment\">//节点类型为text</span></span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">if</span>(node.nodeType === <span class=\"number\">3</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">if</span>(reg.test(node.nodeValue)) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> name = <span class=\"built_in\">RegExp</span>.$<span class=\"number\">1</span>; <span class=\"comment\">// 获取匹配到的字符串</span></span></span><br><span class=\"line\">            name = name.trim();</span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"comment\">// node.nodeValue = vm[name]; // 将data的值赋给该node</span></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">new</span> Watcher(vm, node, name, <span class=\"string\">'nodeValue'</span>);</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dep</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.subs = [];</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Dep.prototype = &#123;</span><br><span class=\"line\"><span class=\"javascript\">      addSub: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">sub</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.subs.push(sub);</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\"><span class=\"javascript\">      notify: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.subs.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">sub</span>) </span>&#123;</span></span><br><span class=\"line\">          sub.update();</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Watcher</span>(<span class=\"params\">vm, node, name, type</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      Dep.target = <span class=\"keyword\">this</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.name = name;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.node = node;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.vm = vm;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.type = type;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.update();</span></span><br><span class=\"line\"><span class=\"javascript\">      Dep.target = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Watcher.prototype = &#123;</span><br><span class=\"line\"><span class=\"javascript\">      update: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.get();</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.node[<span class=\"keyword\">this</span>.type] = <span class=\"keyword\">this</span>.value; <span class=\"comment\">// 订阅者执行相应操作</span></span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// 获取data的属性值</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">get</span>: function() &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.value = <span class=\"keyword\">this</span>.vm[<span class=\"keyword\">this</span>.name]; <span class=\"comment\">//触发相应属性的get</span></span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">defineReactive</span> (<span class=\"params\">obj, key, val</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> dep = <span class=\"keyword\">new</span> Dep();</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">Object</span>.defineProperty(obj, key, &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">get</span>: function() &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">           <span class=\"comment\">//添加订阅者watcher到主题对象Dep</span></span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">if</span>(Dep.target) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"comment\">// JS的浏览器单线程特性，保证这个全局变量在同一时间内，只会有同一个监听器使用</span></span></span><br><span class=\"line\">            dep.addSub(Dep.target);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">return</span> val;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">set</span>: function (newVal) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">if</span>(newVal === val) <span class=\"keyword\">return</span>;</span></span><br><span class=\"line\">          val = newVal;</span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"built_in\">console</span>.log(val);</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"comment\">// 作为发布者发出通知</span></span></span><br><span class=\"line\">          dep.notify();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">observe</span>(<span class=\"params\">obj, vm</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">Object</span>.keys(obj).forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span></span><br><span class=\"line\">        defineReactive(vm, key, obj[key]);</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"javascript\"> 　 <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Vue</span>(<span class=\"params\">options</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.data = options.data;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> data = <span class=\"keyword\">this</span>.data;</span></span><br><span class=\"line\"><span class=\"javascript\">      observe(data, <span class=\"keyword\">this</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> id = options.el;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> dom =<span class=\"keyword\">new</span> Compile(<span class=\"built_in\">document</span>.getElementById(id),<span class=\"keyword\">this</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"comment\">// 编译完成后，将dom返回到app中</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"built_in\">document</span>.getElementById(id).appendChild(dom);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> vm = <span class=\"keyword\">new</span> Vue(&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      el: <span class=\"string\">'app'</span>,</span></span><br><span class=\"line\">      data: &#123;</span><br><span class=\"line\"><span class=\"javascript\">        text: <span class=\"string\">'hello world'</span></span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>参考链接<br><a href=\"http://www.html-js.com/article/Study-of-twoway-data-binding-JavaScript-talk-about-JavaScript-every-day\" target=\"_blank\" rel=\"noopener\">http://www.html-js.com/article/Study-of-twoway-data-binding-JavaScript-talk-about-JavaScript-every-day</a><br><a href=\"https://segmentfault.com/a/1190000006599500\" target=\"_blank\" rel=\"noopener\">https://segmentfault.com/a/1190000006599500</a></p>","categories":[{"name":"vue","path":"api/categories/vue.json"}],"tags":[{"name":"vue","path":"api/tags/vue.json"},{"name":"源码","path":"api/tags/源码.json"}]}