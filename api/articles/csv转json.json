{"title":"CSV转JSON","slug":"csv转json","date":"2023-02-05T02:28:31.000Z","updated":"2023-02-05T02:28:31.000Z","comments":true,"path":"api/articles/csv转json.json","excerpt":"市面上有很多现在的网站，可以实现csv转为需要的格式，但因为项目的csv格式比较特殊，需要手动实现自定义。主要通过三方的 csvtojson npm 包实现。记录过程，方便自定义更多格式。<br>","covers":null,"content":"<p>市面上有很多现在的网站，可以实现csv转为需要的格式，但因为项目的csv格式比较特殊，需要手动实现自定义。</p>\n<p>主要通过三方的 <code>csvtojson</code> npm 包实现。记录过程，方便自定义更多格式。<br><a id=\"more\"></a></p>\n<p>话不多说，简单说下流程。</p>\n<h2 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h2><p>多语言包为csv格式，需要将该格式转为json，便于i18n进行懒加载。</p>\n<p>i18文件夹结构</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--i18n</span><br><span class=\"line\">    |--en_us</span><br><span class=\"line\">        |--en_US.csv</span><br><span class=\"line\">    |--de_de</span><br><span class=\"line\">        |--de_DE.csv</span><br></pre></td></tr></table></figure>\n<p>csv的格式大致如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// i18n/en_us/en_US.csv</span></span><br><span class=\"line\">hello,hello</span><br><span class=\"line\">welcome,welcome</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// i18n/de_de/de_DE.csv</span></span><br><span class=\"line\">hello,Hallo</span><br><span class=\"line\">welcome,Willkommen</span><br></pre></td></tr></table></figure>\n<p>转化后的结构</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// output/en_US.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    hello: hello,</span><br><span class=\"line\">    welcome: welcome</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><p>打开命令行，执行</p>\n<ul>\n<li>mkdir demo</li>\n<li>cd ./demo</li>\n<li>npm init</li>\n<li>npm install csvtojson</li>\n<li>cd &gt;index.js</li>\n<li>mkdir output</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> csv = <span class=\"built_in\">require</span>(<span class=\"string\">\"csvtojson\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">\"fs\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">walkSync</span>(<span class=\"params\">currentDirPath, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">\"fs\"</span>),</span><br><span class=\"line\">    path = <span class=\"built_in\">require</span>(<span class=\"string\">\"path\"</span>);</span><br><span class=\"line\">  fs.readdirSync(currentDirPath, &#123; <span class=\"attr\">withFileTypes</span>: <span class=\"literal\">true</span> &#125;).forEach(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    dirent</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  </span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> filePath = path.join(currentDirPath, dirent.name);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (dirent.isFile()) &#123;</span><br><span class=\"line\">      callback(filePath, dirent);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (dirent.isDirectory()) &#123;</span><br><span class=\"line\">      walkSync(filePath, callback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getFileArr</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> csvFileArr = [];</span><br><span class=\"line\">    walkSync(<span class=\"string\">\"./i18n\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">filePath</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// if(filePath.test(/+\\.csv$/))&#123;</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (filePath.includes(<span class=\"string\">\".csv\"</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> file = <span class=\"string\">`./<span class=\"subst\">$&#123;filePath&#125;</span>`</span>.replace(<span class=\"regexp\">/\\\\/g</span>, <span class=\"string\">\"/\"</span>);</span><br><span class=\"line\">        csvFileArr.push(file);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> csvFileArr</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">csvTojson</span>(<span class=\"params\">fileName</span>) </span>&#123;</span><br><span class=\"line\">  csv(&#123;</span><br><span class=\"line\">    noheader: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    output: <span class=\"string\">\"csv\"</span>,</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">    .fromFile(<span class=\"string\">`<span class=\"subst\">$&#123;fileName&#125;</span>`</span>)</span><br><span class=\"line\">    .then(<span class=\"function\">(<span class=\"params\">jsonArr</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> jsonObj = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> index = <span class=\"number\">0</span>; index &lt; jsonArr.length; index++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> item = jsonArr[index];</span><br><span class=\"line\">        jsonObj[item[<span class=\"number\">0</span>]] = item[<span class=\"number\">1</span>];</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      jsonObj = <span class=\"built_in\">JSON</span>.stringify(jsonObj);</span><br><span class=\"line\">      <span class=\"keyword\">let</span> outFile = fileName.match(<span class=\"regexp\">/(\\w+)\\.csv$/</span>)[<span class=\"number\">1</span>];</span><br><span class=\"line\">      fs.writeFile(</span><br><span class=\"line\">        <span class=\"string\">`./output/<span class=\"subst\">$&#123;outFile&#125;</span>.json`</span>,</span><br><span class=\"line\">        jsonObj,</span><br><span class=\"line\">        <span class=\"string\">\"utf-8\"</span>,</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">console</span>.log(err);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">\"The file was saved!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> fileArr = getFileArr();</span><br><span class=\"line\">fileArr.forEach(<span class=\"function\">(<span class=\"params\">item</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  csvTojson(item);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n","more":"</p>\n<p>话不多说，简单说下流程。</p>\n<h2 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h2><p>多语言包为csv格式，需要将该格式转为json，便于i18n进行懒加载。</p>\n<p>i18文件夹结构</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--i18n</span><br><span class=\"line\">    |--en_us</span><br><span class=\"line\">        |--en_US.csv</span><br><span class=\"line\">    |--de_de</span><br><span class=\"line\">        |--de_DE.csv</span><br></pre></td></tr></table></figure>\n<p>csv的格式大致如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// i18n/en_us/en_US.csv</span></span><br><span class=\"line\">hello,hello</span><br><span class=\"line\">welcome,welcome</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// i18n/de_de/de_DE.csv</span></span><br><span class=\"line\">hello,Hallo</span><br><span class=\"line\">welcome,Willkommen</span><br></pre></td></tr></table></figure>\n<p>转化后的结构</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// output/en_US.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    hello: hello,</span><br><span class=\"line\">    welcome: welcome</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><p>打开命令行，执行</p>\n<ul>\n<li>mkdir demo</li>\n<li>cd ./demo</li>\n<li>npm init</li>\n<li>npm install csvtojson</li>\n<li>cd &gt;index.js</li>\n<li>mkdir output</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// index.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> csv = <span class=\"built_in\">require</span>(<span class=\"string\">\"csvtojson\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">\"fs\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">walkSync</span>(<span class=\"params\">currentDirPath, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">\"fs\"</span>),</span><br><span class=\"line\">    path = <span class=\"built_in\">require</span>(<span class=\"string\">\"path\"</span>);</span><br><span class=\"line\">  fs.readdirSync(currentDirPath, &#123; <span class=\"attr\">withFileTypes</span>: <span class=\"literal\">true</span> &#125;).forEach(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">    dirent</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">  </span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> filePath = path.join(currentDirPath, dirent.name);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (dirent.isFile()) &#123;</span><br><span class=\"line\">      callback(filePath, dirent);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (dirent.isDirectory()) &#123;</span><br><span class=\"line\">      walkSync(filePath, callback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getFileArr</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> csvFileArr = [];</span><br><span class=\"line\">    walkSync(<span class=\"string\">\"./i18n\"</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">filePath</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// if(filePath.test(/+\\.csv$/))&#123;</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (filePath.includes(<span class=\"string\">\".csv\"</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> file = <span class=\"string\">`./<span class=\"subst\">$&#123;filePath&#125;</span>`</span>.replace(<span class=\"regexp\">/\\\\/g</span>, <span class=\"string\">\"/\"</span>);</span><br><span class=\"line\">        csvFileArr.push(file);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> csvFileArr</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">csvTojson</span>(<span class=\"params\">fileName</span>) </span>&#123;</span><br><span class=\"line\">  csv(&#123;</span><br><span class=\"line\">    noheader: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    output: <span class=\"string\">\"csv\"</span>,</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">    .fromFile(<span class=\"string\">`<span class=\"subst\">$&#123;fileName&#125;</span>`</span>)</span><br><span class=\"line\">    .then(<span class=\"function\">(<span class=\"params\">jsonArr</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> jsonObj = &#123;&#125;;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> index = <span class=\"number\">0</span>; index &lt; jsonArr.length; index++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> item = jsonArr[index];</span><br><span class=\"line\">        jsonObj[item[<span class=\"number\">0</span>]] = item[<span class=\"number\">1</span>];</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      jsonObj = <span class=\"built_in\">JSON</span>.stringify(jsonObj);</span><br><span class=\"line\">      <span class=\"keyword\">let</span> outFile = fileName.match(<span class=\"regexp\">/(\\w+)\\.csv$/</span>)[<span class=\"number\">1</span>];</span><br><span class=\"line\">      fs.writeFile(</span><br><span class=\"line\">        <span class=\"string\">`./output/<span class=\"subst\">$&#123;outFile&#125;</span>.json`</span>,</span><br><span class=\"line\">        jsonObj,</span><br><span class=\"line\">        <span class=\"string\">\"utf-8\"</span>,</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">console</span>.log(err);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"built_in\">console</span>.log(<span class=\"string\">\"The file was saved!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      );</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> fileArr = getFileArr();</span><br><span class=\"line\">fileArr.forEach(<span class=\"function\">(<span class=\"params\">item</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  csvTojson(item);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>","categories":[],"tags":[{"name":"csv","path":"api/tags/csv.json"},{"name":"json","path":"api/tags/json.json"}]}